# 🔐 真机调试 SSL 证书问题解决方案

## ❌ 问题现象

真机调试时出现错误：
```
errcode:-207 cronet_error_code:-207
error_msg:net::ERR_CERT_INVALID
```

**原因**：微信小程序不信任自签名 SSL 证书

---

## ✅ 解决方案（3种）

### 方案 1：开发阶段 - 不校验合法域名（推荐）

**步骤**：

1. **打开微信开发者工具**
2. **点击右上角"详情"**
3. **选择"本地设置"标签**
4. **勾选以下选项**：
   - ✅ 不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书
   - ✅ 不校验安全域名、TLS 版本以及 HTTPS 证书

5. **重新编译运行**

**优点**：
- ✅ 最简单快速
- ✅ 适合开发调试
- ✅ 无需修改代码

**缺点**：
- ⚠️ 仅在开发者工具中有效
- ⚠️ 真机预览时仍需要其他方案

---

### 方案 2：真机调试 - 使用 HTTP（临时方案）

**步骤**：

1. **修改配置文件**

编辑 `mp-weixin/config.env.js`：

```javascript
testing: {
  baseURL: 'http://172.20.10.3:8080/nodejsn73cv/',  // 改为 HTTP
  apiRoot: 'nodejsn73cv/',
  description: '测试环境 - 真机调试'
},
```

2. **启动 HTTP 服务器**

```bash
cd nodejsn73cv
node start-http.js
```

3. **开发者工具设置**

勾选"不校验合法域名"（同方案1）

**优点**：
- ✅ 真机可以访问
- ✅ 无需证书

**缺点**：
- ⚠️ 图片等资源可能无法加载（微信要求 HTTPS）
- ⚠️ 仅适合临时调试

---

### 方案 3：使用内网穿透工具（推荐生产环境）

使用内网穿透工具将本地服务映射到公网 HTTPS 域名。

#### 3.1 使用 ngrok

**安装 ngrok**：
1. 访问 https://ngrok.com/
2. 注册账号
3. 下载并安装

**启动服务**：

```bash
# 1. 启动本地 HTTP 服务器
cd nodejsn73cv
node start-http.js

# 2. 新开一个终端，启动 ngrok
ngrok http 8080
```

**配置小程序**：

ngrok 会给你一个 HTTPS 地址，例如：`https://abc123.ngrok.io`

修改 `config.env.js`：
```javascript
testing: {
  baseURL: 'https://abc123.ngrok.io/nodejsn73cv/',
  apiRoot: 'nodejsn73cv/',
  description: '测试环境 - ngrok 穿透'
},
```

#### 3.2 使用 cpolar（国内推荐）

**安装 cpolar**：
1. 访问 https://www.cpolar.com/
2. 注册并下载

**启动服务**：
```bash
# 1. 启动本地服务
cd nodejsn73cv
node start-http.js

# 2. 启动 cpolar
cpolar http 8080
```

**优点**：
- ✅ 提供真实的 HTTPS 证书
- ✅ 真机可以正常访问
- ✅ 图片等资源正常加载

**缺点**：
- ⚠️ 需要注册账号
- ⚠️ 免费版有流量限制

---

### 方案 4：购买域名和 SSL 证书（正式环境）

**适用场景**：正式发布上线

**步骤**：

1. **购买域名**（阿里云、腾讯云等）
2. **购买 SSL 证书**（或使用免费的 Let's Encrypt）
3. **配置服务器**
4. **在微信公众平台配置服务器域名**

---

## 🎯 推荐方案总结

| 场景 | 推荐方案 | 说明 |
|------|---------|------|
| **开发者工具调试** | 方案 1 | 勾选"不校验合法域名" |
| **真机调试（临时）** | 方案 2 | 使用 HTTP + 不校验域名 |
| **真机调试（推荐）** | 方案 3 | 使用 ngrok/cpolar 内网穿透 |
| **正式发布** | 方案 4 | 购买域名和证书 |

---

## 📝 当前问题快速解决

**你的朋友现在遇到的问题，最快的解决方法**：

### 立即可用方案：

**步骤 1**：修改 `mp-weixin/config.env.js`

```javascript
testing: {
  baseURL: 'http://172.20.10.3:8080/nodejsn73cv/',  // 改为 HTTP
  apiRoot: 'nodejsn73cv/',
  description: '测试环境 - 真机调试'
},
```

**步骤 2**：启动 HTTP 服务器

```bash
cd nodejsn73cv
node start-http.js
```

**步骤 3**：微信开发者工具设置

1. 点击右上角"详情"
2. 选择"本地设置"
3. 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
4. 重新编译

**步骤 4**：真机预览

1. 点击工具栏"预览"
2. 扫码在手机上打开
3. 确保手机和电脑在同一 WiFi

---

## ⚠️ 注意事项

1. **开发阶段**：使用 HTTP + 不校验域名即可
2. **图片问题**：如果图片无法加载，使用方案 3（内网穿透）
3. **正式发布**：必须使用 HTTPS 和真实域名

---

## 🔍 验证是否成功

成功后，控制台应该显示：

```
========================================
环境配置信息
========================================
当前环境: testing
API 地址: http://172.20.10.3:8080/nodejsn73cv/
平台信息: ios
========================================
```

并且不再出现 `ERR_CERT_INVALID` 错误。

---

**最后更新**: 2025-11-12

