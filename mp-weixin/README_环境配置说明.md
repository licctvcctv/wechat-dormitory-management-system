# 微信小程序环境配置说明

## 📋 目录

- [概述](#概述)
- [环境类型](#环境类型)
- [配置步骤](#配置步骤)
- [常见问题](#常见问题)
- [文件说明](#文件说明)

---

## 🎯 概述

本项目采用**统一环境配置管理**，支持三种运行环境的自动切换：

1. **开发环境** - 微信开发者工具调试
2. **真机调试环境** - 手机真机调试
3. **生产环境** - 正式发布版本

所有环境配置集中在 `config.env.js` 文件中管理，避免了多处硬编码导致的配置混乱。

---

## 🌍 环境类型

### 1. 开发环境（Development）

**使用场景**：在微信开发者工具中调试

**特点**：
- 自动检测开发者工具环境
- 使用 `localhost:8080` 连接本地后端服务
- 无需任何配置，开箱即用

**API 地址**：`http://localhost:8080/nodejsn73cv/`

---

### 2. 真机调试环境（Debug）

**使用场景**：在手机上进行真机调试

**特点**：
- 自动检测真机环境
- 使用局域网 IP 连接电脑上的后端服务
- **需要手动配置本机 IP 地址**

**API 地址**：`http://YOUR_LOCAL_IP:8080/nodejsn73cv/`（需要配置）

---

### 3. 生产环境（Production）

**使用场景**：正式发布的小程序

**特点**：
- 手动开启生产模式
- 使用线上服务器地址
- **需要配置实际服务器地址**

**API 地址**：`https://your-domain.com/nodejsn73cv/`（需要配置）

---

## ⚙️ 配置步骤

### 步骤 1：开发环境调试（无需配置）

如果您只是在微信开发者工具中调试，**无需任何配置**，直接使用即可。

系统会自动使用 `localhost:8080` 连接本地后端服务。

---

### 步骤 2：真机调试配置

#### 2.1 查看本机 IP 地址

**Windows 系统**：
```bash
# 打开命令提示符（cmd），输入：
ipconfig

# 查找 "IPv4 地址"，例如：192.168.1.100
```

**Mac 系统**：
```bash
# 打开终端，输入：
ifconfig | grep "inet "

# 或者：系统偏好设置 -> 网络 -> 查看 IP 地址
```

**常见 IP 格式**：
- `192.168.x.x`（家庭/办公室网络）
- `10.x.x.x`（企业网络）
- `172.16.x.x` 到 `172.31.x.x`（企业网络）

#### 2.2 修改配置文件

1. 打开文件：`mp-weixin/config.env.js`

2. 找到 `debug` 配置项：

```javascript
debug: {
  baseURL: 'http://YOUR_LOCAL_IP:8080/nodejsn73cv/',  // ⚠️ 请修改 YOUR_LOCAL_IP
  apiRoot: 'nodejsn73cv/',
  description: '真机调试环境 - 需要配置本机IP'
}
```

3. 将 `YOUR_LOCAL_IP` 替换为您的实际 IP 地址，例如：

```javascript
debug: {
  baseURL: 'http://192.168.1.100:8080/nodejsn73cv/',  // ✅ 已修改
  apiRoot: 'nodejsn73cv/',
  description: '真机调试环境 - 需要配置本机IP'
}
```

4. 保存文件

#### 2.3 确保手机和电脑在同一网络

- 手机和电脑必须连接到**同一个 WiFi 网络**
- 确保电脑防火墙允许 8080 端口访问

#### 2.4 启动后端服务

确保后端服务已在电脑上启动，监听 `8080` 端口。

#### 2.5 真机调试

在微信开发者工具中点击"真机调试"，扫码后即可在手机上调试。

---

### 步骤 3：生产环境配置

#### 3.1 修改配置文件

1. 打开文件：`mp-weixin/config.env.js`

2. 找到 `production` 配置项：

```javascript
production: {
  baseURL: 'https://your-domain.com/nodejsn73cv/',  // ⚠️ 请修改为实际服务器地址
  apiRoot: 'nodejsn73cv/',
  description: '生产环境 - 正式服务器'
}
```

3. 将 `your-domain.com` 替换为实际的服务器域名，例如：

```javascript
production: {
  baseURL: 'https://api.example.com/nodejsn73cv/',  // ✅ 已修改
  apiRoot: 'nodejsn73cv/',
  description: '生产环境 - 正式服务器'
}
```

#### 3.2 开启生产模式

1. 打开文件：`mp-weixin/app.js`

2. 找到第 11 行：

```javascript
const IS_PRODUCTION = false;  // ⚠️ 发布时改为 true
```

3. 修改为：

```javascript
const IS_PRODUCTION = true;  // ✅ 生产模式已开启
```

4. 保存文件并重新编译

---

## ❓ 常见问题

### Q1: 真机调试时提示"请求失败"或"网络错误"

**可能原因**：
1. 未配置本机 IP 地址
2. 手机和电脑不在同一网络
3. 电脑防火墙阻止了 8080 端口
4. 后端服务未启动

**解决方法**：
1. 检查 `config.env.js` 中的 IP 配置是否正确
2. 确保手机和电脑连接同一 WiFi
3. 关闭防火墙或添加 8080 端口例外
4. 确认后端服务正在运行

---

### Q2: 控制台显示"⚠️ 配置错误：真机调试环境未配置"

**原因**：您正在真机调试，但 `config.env.js` 中的 IP 地址未修改

**解决方法**：按照 [步骤 2](#步骤-2真机调试配置) 配置本机 IP 地址

---

### Q3: IP 地址经常变化怎么办？

**原因**：路由器使用 DHCP 动态分配 IP

**解决方法**：
1. 在路由器中为电脑设置静态 IP（推荐）
2. 每次 IP 变化后重新修改 `config.env.js`

---

### Q4: 如何查看当前使用的 API 地址？

打开微信开发者工具的控制台（Console），查看启动日志：

```
========================================
环境配置信息
========================================
当前环境: debug
环境描述: 真机调试环境 - 需要配置本机IP
API 地址: http://192.168.1.100:8080/nodejsn73cv/
平台信息: android
========================================
```

---

### Q5: 发布后如何切换回开发模式？

1. 打开 `mp-weixin/app.js`
2. 将 `IS_PRODUCTION` 改回 `false`
3. 保存并重新编译

---

## 📁 文件说明

### 核心配置文件

| 文件 | 作用 | 是否需要修改 |
|------|------|-------------|
| `config.env.js` | 环境配置文件 | ✅ 真机调试和生产环境需要修改 |
| `app.js` | 小程序入口文件 | ✅ 生产环境需要修改 IS_PRODUCTION |
| `mini_fix.js` | 网络请求拦截器 | ❌ 无需修改 |

### 配置文件结构

```
mp-weixin/
├── config.env.js          # 环境配置（需要修改）
├── app.js                 # 入口文件（生产环境需要修改）
├── mini_fix.js            # 请求拦截器（无需修改）
└── README_环境配置说明.md  # 本文档
```

---

## 🔧 技术原理

### 环境自动检测

系统通过 `wx.getSystemInfoSync().platform` 检测当前运行环境：

- `platform === 'devtools'` → 开发环境
- `platform !== 'devtools'` → 真机调试环境
- `IS_PRODUCTION === true` → 生产环境（优先级最高）

### 请求拦截机制

`mini_fix.js` 拦截了所有网络请求（`wx.request`、`uni.request`、`axios`），自动将请求地址替换为当前环境配置的地址。

**拦截流程**：
1. 应用发起请求（例如：`http://localhost:8080/nodejsn73cv/xuesheng/login`）
2. `mini_fix.js` 拦截请求
3. 根据当前环境替换地址
4. 发送实际请求（例如：`http://192.168.1.100:8080/nodejsn73cv/xuesheng/login`）

---

## 📞 技术支持

如果遇到配置问题，请检查：

1. ✅ 是否按照文档正确配置了 IP 地址
2. ✅ 手机和电脑是否在同一网络
3. ✅ 后端服务是否正常运行
4. ✅ 控制台是否有错误提示

---

**最后更新**：2025-11-11

